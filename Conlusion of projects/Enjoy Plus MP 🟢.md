## 项目描述
EP项目是一款面向业主的用于房屋资源管理的微信小程序。功能包括：用户管理、房屋管理，房屋报修与邀请访客等。

%% 项目业务包括：用户管理，如用户登录、资料管理；房屋管理如房屋的增删改查；报修管理如报修申请与取消，报修进度与详情显示；访客管理，如邀请访客与生成限时的二维码。 %%
## 技术栈

原生小程序，Vant

## 技术描述

1. 使用小程序开发者工具创建项目，在`project.config.js`中配置了项目的根目录，所需的编译插件以及npm构建后代码的生成位置等项目基本环境；在`app.json`中配置了路由，窗口样式，底部导航与项目分包结构等项目基本配置
2. 通过`wx.request`封装了请求函数，进行了请求拦截与响应拦截，并在响应拦截里做了登录过期的自动刷新处理
3. 使用`wx.getStorageSync`存储用户信息与`token`，并以此来做权限校验
4. 在个人资料页面，使用了微信内置组件获取用户头像和昵称
5. 使用`wx.getLocation`和腾讯位置服务API实现了地图搜索、根据定位搜索附近小区、报修人员路线规划等功能
6. 使用微信的框架API实现了页面传参与全局数据共享

## 项目框架

```bash
.
├── components // 全局组件
│   └── authorization // 全局组件配合条件渲染、 匿名插槽实现权限区分渲染
├── static
│   ├── images
│   └── tabs
├── utils
│   ├── http.js // 自己封装的请求
│   └── qqmap.js // 腾讯地图位置服务
├── pages
│   ├── index
│   ├── login
│   ├── my
│   ├── notify
│   └── profile
├── house_pkg
│   └── pages
├── repair_pkg
│   ├── pages
│   └── static
└── visitor_pkg
    └── pages
```

## 技术难点

1. **封装组件进行登录的权限校验**
解决：
- 封装全局自定义组件`authorization`
- 在组件的`attached`钩子中获取存在本地的token，并根据有无token来改变变量`isLogin`的布尔值
- 在组件的`wxml`页面里放入一个匿名插槽，将插槽用`wx:if`绑定`isLogin`来判断有无登录
- 在需要权限校验的页面，用`authorization`作为根标签包住页面内容，就可以控制登录了就显示，未登录就不显示或者显示其他文字。并且显示的内容由组件包住的内容决定，具有复用性


2. **双token的登录超时处理**
解决：
- 在类似请求拦截器的函数中，判断报错是否为401，是的话则进入if判断进行处理
- 在本地存储中取出`refreshToken`，发请求更新token
- 该请求为了避免自己封装的请求拦截覆盖掉请求头，需要使用原生`wx.request`接口，手动添加请求头和基地址
- 将获取到的新`token`存到本地，把原请求里的过期`token`替换为新的，再发一次请求
- 把请求的结果返回出去，即可实现无感更新`token`